<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Advanced Blockly Playground</title>
<script src="prepare.js"></script>
<script src="./screenshot.js"></script>
<script src="../themes/test_themes.js"></script>
<script src="../../node_modules/@blockly/dev-tools/dist/index.js"></script>
<script src="../../node_modules/@blockly/theme-modern/dist/index.js"></script>
<script src="./custom_generator.js"></script>
<script type="module">
import Blockly from './blockly.mjs';
'use strict';
//var wspace;

function start() {
  setBackgroundColour();
  initPlayground();
}

function createWorkspace(blocklyDiv, options) {
  var workspace = Blockly.inject(blocklyDiv, options);
  workspace.configureContextMenu = configureContextMenu.bind(workspace);
  //wspace = workspace;
  return workspace;
}

function configurePlayground(playground) {
  // Rendering options.
  playground.addGenerator('Codelab', codelabGenerator);
  
  var gui = playground.getGUI();
  var renderingFolder = gui.addFolder('Rendering');
  var renderingOptions = {
    'font Size': 10,
  };
  renderingFolder.add(renderingOptions, 'font Size', 0, 50)
    .onChange(function(value) {
      var ws = playground.getWorkspace();
      loadBlock(ws);

      var fontStyle = {
        'size': value
      };
      ws.getTheme().setFontStyle(fontStyle);
      // Refresh theme.
      ws.setTheme(ws.getTheme());
      console.log(ws);
    });
}

function initPlayground() {
  if (typeof window.createPlayground === 'undefined') {
    alert('You need to run \'npm install\' in order to use this playground.');
    return;
  }
  var defaultOptions = {
        comments: true,
        collapse: true,
        disable: true,
        grid:
          {
            spacing: 25,
            length: 3,
            colour: '#ccc',
            snap: true
          },
        horizontalLayout: false,
        maxBlocks: Infinity,
        maxInstances: {'test_basic_limit_instances': 3},
        maxTrashcanContents: 256,
        media: '../../media/',
        oneBasedIndex: true,
        readOnly: false,
        rtl: false,
        move: {
          scrollbars: true,
          drag: true,
          wheel: false,
        },
        toolbox: codelabToolbox,
        toolboxPosition: 'start',
        renderer: 'geras',
        zoom:
          {
            controls: true,
            wheel: true,
            startScale: 1.0,
            maxScale: 4,
            minScale: 0.25,
            scaleSpeed: 1.1
          }
  };

  const playgroundConfig = {
    toolboxes: {
      'categories': toolboxCategories,
      'simple': toolboxSimple,
      'test blocks': toolboxTestBlocks,
    }
  }
  var wspace = '<xml xmlns="https://developers.google.com/blockly/xml">  <variables>    <variable id="O!`npk/d_)@Cv;{.UrJ+">item</variable>  </variables>  <block type="variables_set_dynamic" id="CySxo1gV?|E?]T(MR}5s" x="563" y="163">    <field name="VAR" id="O!`npk/d_)@Cv;{.UrJ+">item</field>  </block></xml>'
  createPlayground(document.getElementById('root'), createWorkspace,
      defaultOptions, playgroundConfig,
      'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.19.2/min/vs')
      .then(function(playground) {
        //playground.state.state_.workspaceXml = wspace;
        configurePlayground(playground);
        //console.log(playground.state.state_.workspaceXml);
      });
      console.log(playgroundConfig);
}

function setBackgroundColour() {
  // Set background colour to differentiate file: vs. localhost
  // vs. server copy.
  if (location.protocol == 'file:') {
    document.body.style.backgroundColor = '#89A203';  // Unpleasant green.
  } else if (location.hostname  === 'localhost' ||
      location.hostname === '127.0.0.1' ||
      location.hostname === '[::1]') {
    document.body.style.backgroundColor = '#d6d6ff';  // Familliar lilac.
  }
}


function configureContextMenu(menuOptions, e) {
  var workspace = this;
  var screenshotOption = {
    text: 'Download Screenshot',
    enabled: workspace.getTopBlocks().length,
    callback: function() {
      downloadScreenshot(workspace);
    }
  };
  menuOptions.push(screenshotOption);

  // Adds a default-sized workspace comment to the workspace.
  menuOptions.push(Blockly.ContextMenu.workspaceCommentOption(workspace, e));
}
start();


function loadBlock(ws) { // xml is the same block xml you stored
    /**if (typeof xml != "string" || xml.length < 5) {
      console.log(typeof xml)
        console.log("first false return in loadblock")
        return false;
    }*/
    try {
        console.log(this)
        var dom = Blockly.Xml.textToDom('<xml xmlns="https://developers.google.com/blockly/xml">  <variables>    <variable id="PvGq=#2}dXf-Tx4V8^sq">age</variable>    <variable id="4ZG}Fo?#3L!}ZWEE|q*k">patientmodel</variable>    <variable id="azQ3HKvXN(vNs,$|r-Pv">summary</variable>    <variable id="B88dDzjEEk|U1#?#wVBG">diagnosis</variable>    <variable id="FmljU3_,_Qlg|XbUSnNH">type</variable>  </variables>  <block type="variables_set_dynamic" id="D{C}w=F_[*:f7KhYQJ%s" x="163" y="113">    <field name="VAR" id="PvGq=#2}dXf-Tx4V8^sq">age</field>    <next>      <block type="variables_set_dynamic" id="1KXB4;1Ql+4{`{8!4jf[">        <field name="VAR" id="4ZG}Fo?#3L!}ZWEE|q*k">patientmodel</field>        <next>          <block type="variables_set_dynamic" id="4-HohHUW;~J[rE;aS1ZF">            <field name="VAR" id="azQ3HKvXN(vNs,$|r-Pv">summary</field>            <next>              <block type="variables_set_dynamic" id="u@A+Tfop)XMJI.`?h-nc">                <field name="VAR" id="B88dDzjEEk|U1#?#wVBG">diagnosis</field>                <next>                  <block type="variables_set_dynamic" id="j[nHiCGu;TA.Zo{gr:g8">                    <field name="VAR" id="FmljU3_,_Qlg|XbUSnNH">type</field>                  </block>                </next>              </block>            </next>          </block>        </next>      </block>    </next>  </block></xml>');
        ws.clear();
        Blockly.Xml.domToWorkspace(ws, dom);
        return true;
    } catch (e) {
        console.log(e);
        return false;
    }
}

//loadBlock(xml);
</script>

<style>
  html, body {
    margin: 0;
  }

  .ioLabel>.blocklyFlyoutLabelText {
    font-style: italic;
  }

  .playgroundToggleOptions {
    list-style: none;
    padding: 0;
  }
  .playgroundToggleOptions li {
    margin-top: 1em;
  }

  .zelos-renderer .blocklyFlyoutButton .blocklyText {
    font-size: 1.5rem;
  }
</style>
</head>
<body>
  <div id="root"></div>
</body>
</html>
