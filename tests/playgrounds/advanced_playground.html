<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Blockly Cerebrum Playground</title>
<script src="prepare.js"></script>
<script src="./screenshot.js"></script>
<script src="../themes/test_themes.js"></script>
<script src="https://unpkg.com/@blockly/dev-tools/dist/index.js"></script>
<script src="https://unpkg.com/@blockly/theme-modern/dist/index.js"></script>
<script src="./block_definitions.js"></script>
<script src="./cerebrum_generator.js"></script>
<script src="./cerebrum_toolbox.js"></script>
<script src="./FileHandler.js"></script>
<script src="./AddButtons.js"></script>
<script src="./Prettify.js"></script>
<script src="./BuildBlocksFromCode.js"></script>
<script src="./ParseFileContents.js"></script>
<script src="./CodeToWorkspace.js"></script>
<script src="./xmlstring.js"></script>




<script type="module">
import Blockly from './blockly.mjs';
'use strict';

var wspace;

function start() {
  setBackgroundColour();
  initPlayground();
  addButtons();
  var download = document.getElementById("download-code");
  download.onclick = updateCodeAndDownload;
  setTimeout(hideUnusedGenerators, 125);
}

function allowUpload(workspace){
  setUpFile(workspace);
}

function insertBlocksTest(){
  //workspace.addTopBlock(new Blockly.Block(workspace, 'clickable_reset'));
  //console.log(wspace);
  
  //handleTextXML(workspace)
  let line1 = "$PatientName = 'Lim Ah Nee'";
  let line2 = "$isEWS = 'true'";
  let line3 = "Create $PatientModel $PatientObjName";
  let line4 = "$PatientObjName align $PatientBedLoc 0";
  let line5 = "Do 'NEWS_Nurse/SetupPatient.txt'";
  let line6 = "waitfor";
  let arr = [line4];
  parseArrToWorkspace(arr, wspace);
  // let vd = varDecl(line);
  // buildVariableSetBlock(wspace, vd);
}

function updateCodeAndDownload(){
  var code = cerebrumGenerator.workspaceToCode(wspace);
  var files = codeToFiles(code);
  
  for(let i = 0; i < files.length; i++){
    var a = document.createElement("a");
    a.href = window.URL.createObjectURL(new Blob([files[i].funcText], {type: "text/plain"}));
    a.download = files[i].fname;
    a.click();
  }
}

function populatePatientVars(workspace){
  workspace.createVariable("PatientName", "", "PatientName");
  workspace.createVariable("isEWS", "", "isEWS");
  workspace.createVariable("PatientIC", "", "PatientIC");
  workspace.createVariable("BloodType", "", "BloodType");
  workspace.createVariable("AgeInYears", "", "AgeInYears");
  workspace.createVariable("PatientModel", "", "PatientModel");
  workspace.createVariable("PatientDiag", "", "PatientDiag");
  workspace.createVariable("PatientGender", "", "PatientGender");
  workspace.createVariable("PatientSummary", "", "PatientSummary");
  workspace.createVariable("PatientType", "", "PatientType");
  workspace.createVariable("Temperature", "", "Temperature");
  workspace.createVariable("HR", "", "HR");
  workspace.createVariable("BP", "", "BP");
  workspace.createVariable("BPSys", "", "BPSys");
  workspace.createVariable("Respiration", "", "Respiration");
  workspace.createVariable("SpO2", "", "SpO2");
  workspace.createVariable("PainScore", "", "PainScore");
  workspace.createVariable("AbnormalResponse", "", "AbnormalResponse");
  workspace.createVariable("PatientSpeak", "", "PatientSpeak");
  workspace.createVariable("PatientObjName", "", "PatientObjName");
  workspace.createVariable("PatientBedLoc", "", "PatientBedLoc");
  workspace.createVariable("RigType", "", "RigType");
  workspace.createVariable("HeadAmount", "", "HeadAmount");
  workspace.createVariable("WeightAmount", "", "WeightAmount");
  workspace.createVariable("Patient", "", "Patient");
}

function createWorkspace(blocklyDiv, options) {
  wspace = Blockly.inject(blocklyDiv, options);
  wspace.configureContextMenu = configureContextMenu.bind(wspace);

  populatePatientVars(wspace);
  allowUpload(wspace);
  //insertBlocksTest();
  return wspace;
}

function configurePlayground(playground) {
  playground.addGenerator('Cerebrum', cerebrumGenerator);
  // Rendering options.
  var gui = playground.getGUI();
  gui.addFolder('Upload');
  var renderingFolder = gui.addFolder('Rendering');
  var renderingOptions = {
    'font Size': 10,
  };
  renderingFolder.add(renderingOptions, 'font Size', 0, 50)
    .onChange(function(value) {
      var ws = playground.getWorkspace();
      wspace = ws;
      var fontStyle = {
        'size': value
      };
      ws.getTheme().setFontStyle(fontStyle);
      // Refresh theme.
      ws.setTheme(ws.getTheme());

    });
  
}

function initPlayground() {
  if (typeof window.createPlayground === 'undefined') {
    alert('You need to run \'npm install\' in order to use this playground.');
    return;
  }
  var defaultOptions = {
        comments: true,
        collapse: true,
        disable: true,
        grid:
          {
            spacing: 25,
            length: 3,
            colour: '#ccc',
            snap: true
          },
        horizontalLayout: false,
        maxBlocks: Infinity,
        maxInstances: {'test_basic_limit_instances': 3},
        maxTrashcanContents: 256,
        media: '../../media/',
        oneBasedIndex: true,
        readOnly: false,
        rtl: false,
        move: {
          scrollbars: true,
          drag: true,
          wheel: false,
        },
        toolbox: codelabToolbox,
        toolboxPosition: 'start',
        renderer: 'geras',
        zoom:
          {
            controls: true,
            wheel: true,
            startScale: 1.0,
            maxScale: 4,
            minScale: 0.25,
            scaleSpeed: 1.1
          }
  };

  const playgroundConfig = {
    toolboxes: {
      'categories': toolboxCategories,
      'simple': toolboxSimple,
      'test blocks': toolboxTestBlocks,
    }
  }

  createPlayground(document.getElementById('root'), createWorkspace,
      defaultOptions, playgroundConfig,
      'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.19.2/min/vs')
      .then(function(playground) {
        configurePlayground(playground);
        //console.log("Logging Playground:\n" + playground);
      });
}

function setBackgroundColour() {
  // Set background colour to differentiate file: vs. localhost
  // vs. server copy.
  if (location.protocol == 'file:') {
    document.body.style.backgroundColor = '#89A203';  // Unpleasant green.
  } else if (location.hostname  === 'localhost' ||
      location.hostname === '127.0.0.1' ||
      location.hostname === '[::1]') {
    document.body.style.backgroundColor = '#d6d6ff';  // Familliar lilac.
  }
}


function configureContextMenu(menuOptions, e) {
  var workspace = this;
  var screenshotOption = {
    text: 'Download Screenshot',
    enabled: workspace.getTopBlocks().length,
    callback: function() {
      downloadScreenshot(workspace);
    }
  };
  menuOptions.push(screenshotOption);

  // Adds a default-sized workspace comment to the workspace.
  menuOptions.push(Blockly.ContextMenu.workspaceCommentOption(workspace, e));
}

start();


</script>

<style>
  html, body {
    margin: 0;
  }

  .ioLabel>.blocklyFlyoutLabelText {
    font-style: italic;
  }

  .playgroundToggleOptions {
    list-style: none;
    padding: 0;
  }
  .playgroundToggleOptions li {
    margin-top: 1em;
  }

  .zelos-renderer .blocklyFlyoutButton .blocklyText {
    font-size: 1.5rem;
  }

  /* This styling is used to hide the debug menu */
  div.dg.main {
    display: none !important;
  }

</style>
</head>
<body>
  <div id="root"></div>
</body>
</html>
